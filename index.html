<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Street Light Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 20px; }
    h1 { text-align: center; color: #333; }
    .zone { margin-bottom: 40px; }
    h2 { text-align: center; color: #444; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
    .chart-container { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); height: 300px; }
    .history-section { display: none; margin-top: 20px; }
    .history-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
  </style>
</head>
<body>
  <h1>Smart Street Light Dashboard</h1>

  <!-- Zone Templates (repeat for Z1-Z4) -->
  <div class="zone" id="z1">
    <h2 onclick="toggleHistory('z1')">Zone 1 (Click for History)</h2>
    <div class="charts-grid">
      <div class="chart-container"><canvas id="z1-power-gauge"></canvas></div>
      <div class="chart-container"><canvas id="z1-current-gauge"></canvas></div>
      <div class="chart-container"><canvas id="z1-ldr-gauge"></canvas></div>
      <div class="chart-container"><canvas id="z1-brightness-gauge"></canvas></div>
    </div>
    <div class="history-section" id="z1-history">
      <div class="history-grid">
        <div class="chart-container"><canvas id="z1-power-line"></canvas></div>
        <div class="chart-container"><canvas id="z1-current-line"></canvas></div>
        <div class="chart-container"><canvas id="z1-ldr-line"></canvas></div>
        <div class="chart-container"><canvas id="z1-brightness-line"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Repeat the above div.zone block for z2, z3, z4, changing IDs accordingly -->

  <script>
    // Firebase Config (fill from console)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "idp-eg8.firebaseapp.com",
      databaseURL: "https://idp-eg8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "idp-eg8",
      storageBucket: "idp-eg8.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Gauge creation (real-time)
    function createGauge(id, label, color, max) {
      return new Chart(document.getElementById(id), {
        type: 'doughnut',
        data: { datasets: [{ data: [0, max], backgroundColor: [color, '#e0e0e0'], borderWidth: 0, circumference: 180, rotation: 270 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: label }, tooltip: { enabled: false }, legend: { display: false } }, cutout: '75%' }
      });
    }

    // Line chart creation (history)
    function createLineChart(id, label, color) {
      return new Chart(document.getElementById(id), {
        type: 'line',
        data: { labels: [], datasets: [{ label, data: [], borderColor: color, fill: false }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Time' } }, y: { title: { display: true, text: label } } } }
      });
    }

    const zones = ['Z1', 'Z2', 'Z3', 'Z4'];
    const metrics = ['power', 'current', 'ldr', 'brightness_level'];
    const colors = { power: '#f44336', current: '#ff9800', ldr: '#4caf50', brightness_level: '#2196f3' };
    const maxes = { power: 100, current: 10, ldr: 1023, brightness_level: 100 };
    const charts = { gauges: {}, lines: {} };

    // Initialize charts
    zones.forEach((zone, i) => {
      const zKey = `z${i+1}`;
      charts.gauges[zKey] = {};
      charts.lines[zKey] = {};
      metrics.forEach(metric => {
        charts.gauges[zKey][metric] = createGauge(`${zKey}-${metric}-gauge`, `${metric.charAt(0).toUpperCase() + metric.slice(1)}`, colors[metric], maxes[metric]);
        charts.lines[zKey][metric] = createLineChart(`${zKey}-${metric}-line`, `${metric.charAt(0).toUpperCase() + metric.slice(1)} History`, colors[metric]);
      });

      // Real-time gauges
      db.ref(`SmartStreetLight/${zone}`).on('value', snap => {
        const data = snap.val() || {};
        metrics.forEach(metric => {
          const val = data[metric] || 0;
          charts.gauges[zKey][metric].data.datasets[0].data = [val, maxes[metric] - val];
          charts.gauges[zKey][metric].update();
        });
      });

      // History lines (last 50)
      metrics.forEach(metric => {
        const histRef = db.ref(`history/${zone}/${metric}`);
        const queryRef = histRef.orderByChild('timestamp').limitToLast(50);
        queryRef.on('value', snap => {
          const data = snap.val() || {};
          const entries = Object.values(data).sort((a, b) => a.timestamp - b.timestamp);
          charts.lines[zKey][metric].data.labels = entries.map(e => new Date(e.timestamp).toLocaleTimeString());
          charts.lines[zKey][metric].data.datasets[0].data = entries.map(e => e.value);
          charts.lines[zKey][metric].update();
        });
      });
    });

    // Toggle history view
    function toggleHistory(zKey) {
      const section = document.getElementById(`${zKey}-history`);
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }
  </script>
</body>
</html>
